<div class="sidebar" *ngIf="node() as n">
    <h3>Inspector</h3>
    <div class="scrollable-content">
      <div [ngSwitch]="n.kind">
        <!-- QUESTION -->
        <form *ngSwitchCase="'question'" [formGroup]="fgQ">
          <lib-control-material label="Texto" [smaller]="true" style="width:100%; display: grid;">
            <input formControlName="label" />
          </lib-control-material>

          <lib-control-material-number label="Ordem" [smaller]="true" style="width:100%; display: grid;">
            <input formControlName="seq" />
          </lib-control-material-number>

          <lib-control-material-select bindId="id" bindLabel="label" [selectList]="questionTypes" label="Tipo" [smaller]="true" style="width:100%; display: grid;">
            <input formControlName="type" />
          </lib-control-material-select>
          
          
          <!--<mat-form-field appearance="outline" style="width:100%">
            <mat-label>Tipo</mat-label>
            <mat-select formControlName="type">
              <mat-option value="text">Texto</mat-option>
              <mat-option value="boolean">Boolean</mat-option>
              <mat-option value="integer">Inteiro</mat-option>
              <mat-option value="double">Double</mat-option>
              <mat-option value="select">Lista</mat-option>
              <mat-option value="radio">Radio</mat-option>
              <mat-option value="checkbox">Checkbox</mat-option>
              <mat-option value="date">Data</mat-option>
              <mat-option value="datetime">Data e Hora</mat-option>
              <mat-option value="image">Imagem</mat-option>
            </mat-select>
          </mat-form-field>-->
          <lib-control-material-number label="Score" [smaller]="true" style="width:100%; display: grid;">
            <input formControlName="score" />
          </lib-control-material-number>
          
          <div *ngIf="fgQ.get('type')?.value === 'boolean'">
            <lib-control-material label="Label Verdadeiro" [smaller]="true" style="width:100%; display: grid;">
              <input formControlName="trueLabel" />
            </lib-control-material>
            <lib-control-material label="Label Falso" [smaller]="true" style="width:100%; display: grid;">
              <input formControlName="falseLabel" />
            </lib-control-material>
          </div>
          <div *ngIf="['select','radio','checkbox'].includes(fgQ.get('type')?.value)">
            <div formArrayName="options">
              <div style="font-weight: bold;">Opções</div>
              <div *ngFor="let opt of options.controls; let i=index" [formGroupName]="i" class="option-row">
                <lib-control-material label="Label" [smaller]="true" style="width:40%; display: grid;">
                  <input formControlName="label">
                </lib-control-material>
                <lib-control-material label="Valor" [smaller]="true" style="width:40%; display: grid;">
                  <input formControlName="value">
                </lib-control-material>               
                <lib-control-material-number label="Score" [smaller]="true" style="width:20%; display: grid;">
                  <input formControlName="score" />
                </lib-control-material-number>
                
                <button mat-icon-button type="button" (click)="removeOption(i)">
                  <fa-icon [icon]="faTrash"></fa-icon>
                </button>
              </div>
              <button mat-stroked-button type="button" (click)="addOption()">Adicionar Opção</button>
            </div>
          </div>
        </form>

        <!-- END (Final) -->
        <div *ngSwitchCase="'end'" [formGroup]="fgEnd">
          <div style="font-weight: 600; margin-bottom: 8px;">Condições por Score Final</div>
          <div formArrayName="conditions">
            <div *ngFor="let g of endConditionsArray.controls; let i = index" [formGroupName]="i" class="option-row" style="align-items:flex-start; gap:8px; flex-direction: column;">
              <lib-control-material label="Nome" [smaller]="true" style="width:100%; display:grid;">
                <input formControlName="name" />
              </lib-control-material>

              <div style="display:flex; align-items:center; gap:8px; width:100%;">
                <div style="width:auto; font-size:12px; color:#6b7280;">Score Final</div>

                <mat-form-field appearance="outline" style="width:120px">
                  <mat-label>Operador</mat-label>
                  <mat-select formControlName="operator">
                    <mat-option value="==">==</mat-option>
                    <mat-option value="!=">!=</mat-option>
                    <mat-option value=">=">>=</mat-option>
                    <mat-option value=">">></mat-option>
                    <mat-option value="<="><=</mat-option>
                    <mat-option value="<"><</mat-option>
                  </mat-select>
                </mat-form-field>

                <lib-control-material-number label="Valor" [smaller]="true" style="width:160px; display:grid;">
                  <input formControlName="value" />
                </lib-control-material-number>

                <button mat-icon-button type="button" (click)="removeEndCondition(i)">
                  <fa-icon [icon]="faTrash"></fa-icon>
                </button>
              </div>
            </div>
          </div>
          <button mat-stroked-button type="button" (click)="addEndCondition()" class="add-condition-btn">
            <fa-icon [icon]="faPlus"></fa-icon> Adicionar Condição
          </button>
          <div style="color:#6b7280; font-size:12px; margin-top:6px;">Cada saída só conecta a nós de Ação.</div>
        </div>

        <!-- CONDITION -->
        <div *ngSwitchCase="'condition'">
          <div>
            <ng-container *ngFor="let condition of conditionData; let i = index">
              <app-condition-editor
                *ngIf="conditionType === 'comparison'"
                [condition]="$any(condition)"
                [index]="i"
                [availableQuestions]="availableQuestions()"
                [availableConditions]="availableConditions()"
                (remove)="removeCondition(i)">
              </app-condition-editor>
              <app-expression-condition-editor
                *ngIf="conditionType === 'expression'"
                [condition]="$any(condition)"
                [index]="i"
                (remove)="removeCondition(i)">
              </app-expression-condition-editor>
            </ng-container>
          </div>

          <button mat-stroked-button type="button" (click)="addCondition()" class="add-condition-btn">
            <fa-icon [icon]="faPlus"></fa-icon> Adicionar Condição
          </button>          
        </div>

        <!-- ACTION -->
        <form *ngSwitchCase="'action'" [formGroup]="fgA">
          <mat-form-field appearance="outline" style="width:100%">
            <mat-label>Tipo de Ação</mat-label>
            <mat-select formControlName="type">
              <mat-option value="sendNotification">Enviar Notificação</mat-option>              
            </mat-select>
          </mat-form-field>
        </form>
      </div>
    </div>
    <div class="actions">
      <button mat-button type="button" (click)="cancel()">
        <fa-icon [icon]="faTimes"></fa-icon>
        Cancelar
      </button>
      <button mat-raised-button color="primary" type="button" (click)="save()">
        <fa-icon [icon]="faCheck"></fa-icon>
        Salvar
      </button>
    </div>
  </div>



