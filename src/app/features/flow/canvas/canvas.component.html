<div
    #canvasEl
    class="canvas"
    [class.disable-selection]="nodeDragging"
    [class.pan-ready]="spacePressed"
    [class.panning]="panning"
    (mousedown)="startPan($event)"
    (mousemove)="onMove($event)"
    (mouseup)="onCanvasMouseUp()"
    (mouseleave)="onCanvasMouseUp()"
    (click)="onCanvasClick($event)"
    (wheel)="onWheel($event)"
  >
    <div
      class="canvas-inner"
      [ngStyle]="{ transform: 'translate(' + offset.x + 'px,' + offset.y + 'px) scale(' + zoom + ')', 'transform-origin': '0 0' }">

      <!-- Edges -->
      <svg class="edge-svg" [attr.width]="worldW" [attr.height]="worldH" [attr.viewBox]="'0 0 ' + worldW + ' ' + worldH" [style.overflow]="'visible'">
        <ng-container *ngFor="let e of graph().edges">
          <g (mouseenter)="hoveredEdgeId = e.id" (mouseleave)="hoveredEdgeId = null">
            <path
              [attr.d]="pathBetween(e)"
              fill="none"
              [attr.stroke]="edgeStrokeColor(e)"
              [attr.stroke-width]="edgeStrokeWidth(e)"
              [attr.marker-end]="hoveredEdgeId === e.id ? 'url(#arrow-red)' : 'url(#arrow)'" />
            <foreignObject *ngIf="e.label" [attr.x]="edgeMidpoint(e).x - 40" [attr.y]="edgeMidpoint(e).y - 12" width="80" height="24">
              <div xmlns="http://www.w3.org/1999/xhtml" class="edge-label">{{ e.label }}</div>
            </foreignObject>
            <foreignObject *ngIf="hoveredEdgeId === e.id" [attr.x]="edgeMidpoint(e).x - 12" [attr.y]="edgeMidpoint(e).y - 12" width="24" height="24">
              <div xmlns="http://www.w3.org/1999/xhtml">
                <button class="edge-delete" (click)="removeEdge(e.id, $event)">
                  <fa-icon [icon]="faTrash"></fa-icon>
                </button>
              </div>
            </foreignObject>
          </g>
        </ng-container>
        <path *ngIf="connectingFrom"
          [attr.d]="pathToPoint(connectingFrom!, tempConnection)"
          fill="none" stroke="#b9bed1" stroke-width="2" marker-end="url(#arrow)" />
        <defs>
          <marker id="arrow" markerWidth="10" markerHeight="10" refX="10" refY="3" orient="auto">
            <path d="M0,0 L0,6 L9,3 z" fill="#b9bed1" />
          </marker>
          <marker id="arrow-red" markerWidth="10" markerHeight="10" refX="10" refY="3" orient="auto">
            <path d="M0,0 L0,6 L9,3 z" fill="#ff4d4f" />
          </marker>
        </defs>
      </svg>

      <!-- Nodes -->
      <div
        *ngFor="let n of graph().nodes"
        cdkDrag
        (cdkDragStarted)="dragStart($event)"
        (cdkDragMoved)="dragMove(n, $event)"
        (cdkDragEnded)="dragEnd(n, $event)"
        [ngStyle]="{ left: n.position.x + 'px', top: n.position.y + 'px' }"
        class="node-wrapper"
        [class.condition]="n.kind === 'condition'"
        [class.end]="n.kind === 'end'">

        <div class="selection-offset" [style.transform]="selectionTransform(n.id)">
          <div class="handle in" *ngIf="connectingFrom && connectingFrom !== n.id" (mouseup)="finishConnection(n.id, $event)"></div>

          <div
            class="node"
            cdkDragHandle
            [class.disable-selection]="nodeDragging"
            [class.question]="n.kind === 'question'"
            [class.condition]="n.kind === 'condition'"
            [class.action]="n.kind === 'action'"
            [class.end]="n.kind === 'end'"
            [class.selected]="isSelected(n.id)"
            (click)="$event.stopPropagation(); select(n.id)"
            (dblclick)="$event.stopPropagation(); startEdit(n)"
            (contextmenu)="$event.preventDefault(); $event.stopPropagation(); openContextMenu(n, $event)">

          
          
          <!-- Action buttons (show only when node is selected) -->
          <div class="node-actions" *ngIf="isSelected(n.id)">
            <ng-container *ngIf="n.kind === 'end'; else defaultButtons">
              <button mat-icon-button class="action-btn edit-btn" (click)="startEdit(n)" title="Editar">
                <fa-icon [icon]="faEdit"></fa-icon>
              </button>
              <button mat-icon-button class="action-btn delete-btn" (click)="deleteNode(n.id)" title="Excluir">
                <fa-icon [icon]="faTrash"></fa-icon>
              </button>
            </ng-container>
            <ng-template #defaultButtons>
              <button mat-icon-button class="action-btn edit-btn" (click)="startEdit(n)" title="Editar">
                <fa-icon [icon]="faEdit"></fa-icon>
              </button>
              <button mat-icon-button class="action-btn delete-btn" (click)="deleteNode(n.id)" title="Excluir">
                <fa-icon [icon]="faTrash"></fa-icon>
              </button>
            </ng-template>
          </div>

          <ng-container [ngSwitch]="n.kind">

            <!-- Question = Parallelogram -->
            <app-node-question *ngSwitchCase="'question'" [node]="n"></app-node-question>

            <!-- Condition = Diamond -->
            <app-node-condition *ngSwitchCase="'condition'" [node]="n"></app-node-condition>

            <!-- Action = Rectangle -->
            <div *ngSwitchCase="'action'">
              <div class="title"><fa-icon [icon]="faGear"></fa-icon> Ação #{{ n.data.seq }}</div>
              <div class="sub">{{ n.data.type || 'Enviar Notificação' }}</div>
              </div>

            <!-- End = Capsule -->
            <div *ngSwitchCase="'end'" class="end">
              <div class="content">
                <div class="title">FIM</div>
              </div>
            </div>

          </ng-container>
        </div>

        <!-- Handles de saída para condições -->
        <ng-container *ngIf="n.kind === 'condition' && (isSelected(n.id) || n.data.conditions?.length > 1)">
          <div
            *ngFor="let condition of n.data.conditions; let i = index"
            class="handle out condition-handle"
            [attr.data-condition-id]="condition.id"
            (mousedown)="startConnection(n.id, $event, condition.id)"
            [ngStyle]="{ top: conditionHandleTop(totalConditionHandles(n.id), i) + 'px' }">
            <span class="handle-label">{{ condition.name || 'Condição ' + (i + 1) }}</span>
          </div>
          <div
            *ngIf="hasAllConditionsEdge(n.id)"
            class="handle out condition-handle all-conditions-handle"
            (mousedown)="$event.stopPropagation()"
            [ngStyle]="{ top: conditionHandleTop(totalConditionHandles(n.id), n.data.conditions.length) + 'px' }">
            <span class="handle-label">Todas as condições</span>
          </div>
        </ng-container>
        
        <!-- Handle de saída padrão para outros nós -->
        <!-- Handles de saída para o nó final (condições por score) -->
        <ng-container *ngIf="n.kind === 'end' && (isSelected(n.id) || n.data.conditions?.length > 0)">
          <div
            *ngFor="let c of n.data.conditions; let i = index"
            class="handle out condition-handle"
            [attr.data-condition-id]="c.id"
            (mousedown)="startConnection(n.id, $event, c.id)"
            [ngStyle]="{ top: endConditionHandleTop(n.data.conditions.length, i) + 'px' }">
            <span class="handle-label">{{ c.name || 'Condição ' + (i + 1) }}</span>
          </div>
        </ng-container>
        
        <div class="handle out" *ngIf="isSelected(n.id) && n.kind !== 'condition' && !(n.kind==='end' && n.data.conditions?.length)" (mousedown)="startConnection(n.id, $event)"></div>
        </div>
      </div>

      <!-- Context Menu -->
      <div *ngIf="contextMenu.visible" class="context-menu" [ngStyle]="{ left: contextMenu.x + 'px', top: contextMenu.y + 'px' }" (click)="$event.stopPropagation()">
        <button class="ctx-item" (click)="onContextAction('duplicate')">
          <fa-icon [icon]="faClone"></fa-icon>
          <span>Duplicar</span>
        </button>
        <button class="ctx-item" (click)="onContextAction('edit')">
          <fa-icon [icon]="faEdit"></fa-icon>
          <span>Editar</span>
        </button>
        <button class="ctx-item danger" (click)="onContextAction('delete')">
          <fa-icon [icon]="faTrash"></fa-icon>
          <span>Excluir</span>
        </button>
      </div>
    <div *ngIf="selectionBox"
         class="selection-box"
         [class.dragging]="draggingSelection"
         [class.marquee]="marqueeActive"
         [ngStyle]="{
           left: selectionBox.x + 'px',
           top: selectionBox.y + 'px',
           width: selectionBox.width + 'px',
           height: selectionBox.height + 'px',
           cursor: draggingSelection ? 'grabbing' : 'grab',
           'pointer-events': marqueeActive ? 'none' : 'auto'
         }"></div>
    </div>
    <div class="zoom-controls">
      <button (click)="zoomIn()">+</button>
      <button (click)="zoomOut()">-</button>
    </div>

    <div class="mini-map">
      <div class="view" [ngStyle]="{
          left: viewBox.left + 'px',
          top: viewBox.top + 'px',
          width: viewBox.width + 'px',
          height: viewBox.height + 'px'
        }"></div>
    </div>
  </div>
