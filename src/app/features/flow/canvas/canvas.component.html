<div
    class="canvas"
    (mousedown)="startPan($event)"
    (mousemove)="onPan($event)"
    (mouseup)="endPan()"
    (mouseleave)="endPan()"
    (click)="deselect()"
  >
    <div class="canvas-inner" [ngStyle]="{ transform: 'translate(' + offset.x + 'px,' + offset.y + 'px)' }">
 
       <!-- Edges -->
       <svg class="edge-svg">
         <ng-container *ngFor="let e of graph().edges">
           <line
             [attr.x1]="centerX(e.from)" [attr.y1]="centerY(e.from)"
             [attr.x2]="centerX(e.to)"   [attr.y2]="centerY(e.to)"
             stroke="#b9bed1" stroke-width="2" marker-end="url(#arrow)" />
         </ng-container>
         <defs>
           <marker id="arrow" markerWidth="10" markerHeight="10" refX="10" refY="3" orient="auto">
             <path d="M0,0 L0,6 L9,3 z" fill="#b9bed1" />
           </marker>
         </defs>
       </svg>
 
       <!-- Nodes -->
       <div
         *ngFor="let n of graph().nodes"
         cdkDrag
         (cdkDragEnded)="dragEnd(n, $event)"
         [ngStyle]="{ left: n.position.x + 'px', top: n.position.y + 'px' }"
        class="node-wrapper">

        <div
          class="node"
          [class.question]="n.kind === 'question'"
          [class.condition]="n.kind === 'condition'"
          [class.action]="n.kind === 'action'"
          [class.selected]="isSelected(n.id)"
          (click)="$event.stopPropagation(); select(n.id)">

          <ng-container [ngSwitch]="n.kind">

            <!-- Question = Parallelogram -->
            <div *ngSwitchCase="'question'" class="content">
              <div class="title">üí¨ Quest√£o</div>
              <div style="font-size:18px">{{ n.data.label || 'Pergunta' }}</div>
              <div class="sub">{{ n.data.type | titlecase }}</div>
              <div class="actions">
                <button mat-icon-button (click)="connectFrom(n); $event.stopPropagation()">
                  <mat-icon>call_made</mat-icon>
                </button>
                <button mat-icon-button (click)="remove(n.id); $event.stopPropagation()">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
             </div>
 
            <!-- Condition = Diamond -->
            <div *ngSwitchCase="'condition'" class="diamond">
              <div class="content">
                <div class="title">üîó Condi√ß√£o</div>
                <div class="sub">{{ n.data.operator || '√â igual a' }} {{ n.data.value ?? '' }}</div>
              </div>
             </div>

            <!-- Action = Rectangle -->
            <div *ngSwitchCase="'action'">
              <div class="title">‚úâÔ∏è A√ß√£o</div>
              <div class="sub">{{ n.data.type || 'emitAlert' }}</div>
              <div class="actions" style="margin-top:8px">
                <button mat-icon-button (click)="connectFrom(n); $event.stopPropagation()">
                  <mat-icon>call_made</mat-icon>
                </button>
                <button mat-icon-button (click)="remove(n.id); $event.stopPropagation()">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
             </div>
          </ng-container>
        </div>
       </div>
     </div>
   </div>